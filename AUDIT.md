# Аудит проекта

Дата: 2025-02-14

## Область обзора
- Репозиторий в текущем виде, без запуска и без изменений кода.
- Источники: структура файлов, backend FastAPI, frontend Next.js, Docker-конфиги.

## Архитектурные проблемы (слои/ответственность)
- Контроллеры FastAPI напрямую используют ORM и инкапсулируют бизнес-логику (например, `backend/app/api/projects.py`, `backend/app/api/courses.py`, `backend/app/api/blog.py`), отсутствует слой use-cases и репозитории.
- DTO/валидации частично живут в роутерах (например, `ContactFormData` в `backend/app/api/contact.py`), что размывает слой интерфейса и домена.
- Инфраструктурные детали пробрасываются в контроллеры (например, файловая система и создание директорий в `backend/app/api/upload.py`), нет явного инфраструктурного слоя.
- Сервисы (`backend/app/services/*`) покрывают только часть логики (auth/email/oauth), остальная логика сконцентрирована в роутерах.

## Проблемы ORM/миграций/схем
- Миграции реализованы SQL-скриптами в `backend/scripts/*.sql`, но Alembic присутствует как зависимость без конфигурации и реального использования (см. `backend/requirements.txt`, `backend/README.md`).
- Миграции применяются через Docker init-монтирование (`docker-compose.dev.yml`, `docker-compose.prod.yml`), что затрудняет повторяемость и контроль версий в не-docker окружениях.
- Есть параллельные/legacy миграции в `supabase/migrations/001_initial_schema.sql`, что создает риск расхождения источников правды.
- Имеются ручные инструкции миграции (см. `MIGRATION_INSTRUCTIONS.md`), что указывает на отсутствие единого процесса миграций.
- Возможен дрейф между ORM-моделями и SQL-скриптами (нужна сверка схем с `backend/app/models/*.py`).

## Подозрительные/дубли/возможный мертвый код (требует проверки)
- Supabase-клиенты: `lib/supabase/client.ts`, `lib/supabase/server.ts` и `types/database.ts` выглядят неиспользуемыми (по поиску нет импортов вне самих файлов).
- `supabase/migrations/001_initial_schema.sql` похож на legacy-артефакт.
- Директория `__v0_reference__` содержит дубликаты UI/ассетов — вероятно reference-only.
- Несколько вариантов Docker/скриптов запуска (например, `docker-start.sh`, `scripts/docker-dev.sh`) — требуется убедиться, что все нужны и поддерживаются.

## DX/структура/инфраструктура
- `docker-compose.prod.yml` содержит ошибку отступов в разделе volume (строка с `add_directors_fields.sql`), что делает файл невалидным YAML.
- В репозитории присутствуют `.env`, `.env.local`, `backend/.env`. Это риск утечки секретов и конфликтует с best-practice (обычно хранится `.env.example` + gitignore).
- В README упоминаются Alembic и pytest, но инфраструктуры Alembic и тестов backend не видно (риск расхождения документации и реальности).
- Тесты есть только на frontend-утилиты (`lib/utils/__tests__/*`); backend-тестов нет.
- Конфигурация окружения есть в `lib/env.ts`, `lib/env.server.ts`, но нет единого источника `.env.example`.

## Быстрые выигрыши (low risk)
- Исправить YAML-ошибку в `docker-compose.prod.yml`.
- Добавить `.env.example` (frontend и backend) и исключить реальные `.env` из репозитория.
- Убрать DTO из роутеров: перенести `ContactFormData` в `backend/app/schemas`.
- Вынести работу с upload-путями из `backend/app/api/upload.py` в инфраструктурный слой/конфиг.
- Добавить минимальные smoke-тесты backend (health check).

## Рискованные изменения (high risk)
- Внедрение Alembic как единого источника миграций и перенос существующих SQL-скриптов в ревизии.
- Полная декомпозиция слоев (Domain/Application/Infrastructure/Delivery) с переносом модулей и массовым обновлением импортов.
- Удаление `__v0_reference__`, `supabase/*` и других legacy-артефактов без подтверждения, что они не используются.
- Рефакторинг авторизации/аутентификации и токенов (возможен breaking change для клиентской части).

## Примечания/предпосылки
- Проект сочетает Next.js frontend и FastAPI backend, но архитектурно backend ближе к "CRUD + ORM в контроллерах".
- Для безопасной реорганизации потребуется валидация схем БД и сопоставление с моделями.
